app-id: net.sonobus.SonoBus
runtime: org.freedesktop.Platform
sdk: org.freedesktop.Sdk
runtime-version: '20.08'
command: sonobus
finish-args:
  - --share=ipc
  - --socket=x11
  - --device=dri
  - --share=network
  - --socket=pulseaudio
  - --socket=system-bus
  - --filesystem=host
# Jack
  - --filesystem=xdg-run/pipewire-0
  - --socket=system-bus
#add-extensions:
  #'org.freedesktop.LinuxAudio.Plugins':
    #directory: extensions/Plugins
    #version: "20.08"
    #add-ld-path: "lib"
    #merge-dirs: "ladspa;lv2;lxvst;vst3"
    #subdirectories: true
    #no-autodownload: true
    
cleanup:
  #- /include
  #- /lib/cmake
  #- /lib/pkgconfig
  #- /share/doc
  #- /share/man
  #- /etc
  #- "*.la"
  #- "*.a"

modules:
  - name: Opus
    sources:
      - type: archive
        url: https://archive.mozilla.org/pub/opus/opus-1.3.1.tar.gz
        sha256: 65b58e1e25b2a114157014736a3d9dfeaad8d41be1c8179866f144a2fb44ff9d
        
  - name: jack2
    buildsystem: simple
    build-commands:
      - ./waf configure --prefix=/app --htmldir=/app/share/doc/jack/ --classic
      - ./waf build -j $FLATPAK_BUILDER_N_JOBS
      - ./waf install
    cleanup:
      - '*'
    sources:
      - type: archive
        url: https://github.com/jackaudio/jack2/archive/refs/tags/v1.9.17.tar.gz
        sha256: 38f674bbc57852a8eb3d9faa1f96a0912d26f7d5df14c11005ad499c8ae352f2

  - name: SonoBus
    buildsystem: simple
    build-commands:
      - CONFIG=Release make -j$(nproc) -C Builds/LinuxMakefile Standalone VST3
      - mkdir -p ${FLATPAK_DEST}/bin/
      - mkdir -p ${FLATPAK_DEST}/lib/vst3/
      - cp -a Builds/LinuxMakefile/build/sonobus ${FLATPAK_DEST}/bin/
      - cp -a Builds/LinuxMakefile/build/sonobus.vst3 ${FLATPAK_DEST}/lib/vst3/
      - install -Dm644 Builds/LinuxMakefile/sonobus.desktop /app/share/applications/
      - desktop-file-edit --set-key=Exec --set-value=${FLATPAK_ID} /app/share/applications/${FLATPAK_ID}.desktop
    sources:
      - type: git
        url: https://github.com/sonosaurus/sonobus/
        tag: 1.4.2
        commit: 91c59a3bf5a7fe77b8424259c8271bbd6ad57dca
